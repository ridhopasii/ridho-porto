<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= article ? 'Edit' : 'Write' %> Article - Admin Panel
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0a0a0a;
            color: white;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            color: #9ca3af;
            transition: all 0.2s;
        }

        .sidebar-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-link.active {
            background: rgba(20, 184, 166, 0.1);
            color: #2dd4bf;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: white;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #14b8a6;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body class="flex min-h-screen">
    <%- include('../partials/sidebar', { path: '/admin/articles' }) %>

        <main class="flex-1 ml-64 p-8">
            <%- include('../partials/header', { title: article ? 'Edit Article' : 'Write New Article' }) %>

                <div class="max-w-4xl mx-auto">
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-8">

                        <% if (typeof error !=='undefined' && error) { %>
                            <div class="mb-4 p-4 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400">
                                <%= error %>
                            </div>
                            <% } %>

                                <form action="/admin/articles<%= article ? '/edit/' + article.id : '/create' %>"
                                    method="POST" enctype="multipart/form-data" class="space-y-6">

                                    <div>
                                        <label class="form-label">Title</label>
                                        <input type="text" name="title" value="<%= article ? article.title : '' %>"
                                            required class="form-input">
                                    </div>

                                    <div>
                                        <label class="form-label">Content (HTML supported)</label>
                                        <textarea name="content" rows="12" required
                                            class="form-input font-mono text-sm"><%= article ? article.content : '' %></textarea>
                                    </div>

                                    <div>
                                        <label class="form-label">Tags (comma separated)</label>
                                        <input type="text" name="tags" value="<%= article ? article.tags : '' %>"
                                            placeholder="tech, tutorial, life" class="form-input">
                                    </div>

                                    <div class="space-y-4">
                                        <label class="text-sm font-medium text-gray-400">Cover Image</label>

                                        <% if (article && article.imageUrl) { %>
                                            <div class="group relative inline-block">
                                                <% var currentImg=article.imageUrl.startsWith('http') ?
                                                    ('https://images.weserv.nl/?url=' + encodeURIComponent(article.imageUrl)) : article.imageUrl; %>
                            <img src="<%= currentImg %>" alt="Current" class="h-40 w-auto rounded-xl object-cover border-2 border-white/10 group-hover:border-teal-500/50 transition-all shadow-2xl">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                                <span class="text-xs uppercase tracking-widest font-bold">Current Image</span>
                            </div>
                        </div>
                        <% } %>

                        <% var isUrl = (article && article.imageUrl && article.imageUrl.indexOf(' /uploads/') !==0) ?
                                                    true : false; %>

                                                    <div
                                                        class="bg-black/40 border border-white/5 rounded-2xl p-6 backdrop-blur-sm">
                                                        <div
                                                            class="inline-flex p-1 bg-white/5 rounded-xl mb-6 relative w-full sm:w-auto">
                                                            <div id="toggleHighlight"
                                                                class="absolute h-[calc(100%-8px)] transition-all duration-300 ease-out bg-teal-500 rounded-lg shadow-lg">
                                                            </div>

                                                            <label
                                                                class="relative flex-1 sm:w-32 py-2 text-center cursor-pointer z-10">
                                                                <input type="radio" name="imageSource" value="file"
                                                                    <%=!isUrl ? 'checked' : '' %> class="sr-only"
                                                                onchange="updateToggleUI('file')">
                                                                <span id="labelFile"
                                                                    class="text-sm font-semibold transition-colors duration-300 <%= !isUrl ? 'text-black' : 'text-gray-400' %>">Upload
                                                                    File</span>
                                                            </label>

                                                            <label
                                                                class="relative flex-1 sm:w-32 py-2 text-center cursor-pointer z-10">
                                                                <input type="radio" name="imageSource" value="url"
                                                                    <%=isUrl ? 'checked' : '' %> class="sr-only"
                                                                onchange="updateToggleUI('url')">
                                                                <span id="labelUrl"
                                                                    class="text-sm font-semibold transition-colors duration-300 <%= isUrl ? 'text-black' : 'text-gray-400' %>">Image
                                                                    URL</span>
                                                            </label>
                                                        </div>

                                                        <div class="space-y-4">
                                                            <div id="fileInputContainer" class="hidden">
                                                                <div
                                                                    class="border-2 border-dashed border-white/10 hover:border-teal-500/30 rounded-xl p-8 text-center transition-colors group">
                                                                    <input type="file" name="image" id="fileInput"
                                                                        accept="image/*"
                                                                        onchange="handleFileSelect(this)"
                                                                        class="sr-only">
                                                                    <label for="fileInput" class="cursor-pointer">
                                                                        <div
                                                                            class="bg-teal-500/10 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                                                            <i data-lucide="upload"
                                                                                class="w-6 h-6 text-teal-400"></i>
                                                                        </div>
                                                                        <p class="text-sm text-gray-300 font-medium">
                                                                            Click to upload or drag and drop</p>
                                                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG,
                                                                            WEBP up to 5MB</p>
                                                                    </label>
                                                                </div>
                                                            </div>

                                                            <div id="urlInputContainer" class="hidden">
                                                                <div class="relative group">
                                                                    <div
                                                                        class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500">
                                                                        <i data-lucide="link" class="w-4 h-4"></i>
                                                                    </div>
                                                                    <input type="url" name="imageUrl"
                                                                        value="<%= isUrl ? article.imageUrl : '' %>"
                                                                        placeholder="Paste image URL here..."
                                                                        oninput="handleUrlInput(this)"
                                                                        class="form-input pl-11">
                                                                </div>
                                                            </div>

                                                            <div id="imagePreview"
                                                                class="hidden group relative inline-block mt-4 overflow-hidden rounded-xl">
                                                                <p
                                                                    class="text-xs uppercase tracking-widest text-gray-500 mb-2 font-bold">
                                                                    Preview</p>
                                                                <img src="" alt="Preview"
                                                                    class="h-48 w-full object-cover rounded-xl border border-white/10 shadow-xl">
                                                                <button type="button" onclick="clearPreview()"
                                                                    class="absolute top-8 right-2 p-1.5 bg-red-500/80 hover:bg-red-500 text-white rounded-lg transition-all">
                                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                                </button>
                                                            </div>

                                                            <p id="fileError"
                                                                class="text-xs text-red-400 font-medium hidden"></p>
                                                        </div>

                                                        <div id="uploadProgress"
                                                            class="hidden mt-6 bg-white/5 rounded-2xl p-4 border border-white/5">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <div class="flex items-center gap-2">
                                                                    <div
                                                                        class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center">
                                                                        <i data-lucide="loader-2"
                                                                            class="w-4 h-4 text-teal-400 animate-spin"></i>
                                                                    </div>
                                                                    <span class="text-sm font-bold text-gray-200"
                                                                        id="uploadLabel">Processing...</span>
                                                                </div>
                                                                <span class="text-xs font-mono text-teal-400"
                                                                    id="uploadPercent">0%</span>
                                                            </div>
                                                            <div
                                                                class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                                                                <div id="uploadBar"
                                                                    class="bg-gradient-to-r from-teal-500 to-emerald-400 h-1.5 rounded-full transition-all duration-300"
                                                                    style="width:0%"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                            </div>

                                            <div class="flex items-center gap-3">
                                                <input type="checkbox" name="published" id="published"
                                                    class="w-5 h-5 accent-teal-500" <%=article && article.published
                                                    ? 'checked' : '' %>>
                                                <label for="published"
                                                    class="mb-0 cursor-pointer text-sm text-gray-300">Publish
                                                    now?</label>
                                            </div>

                                            <div class="flex gap-4 pt-4">
                                                <button type="submit"
                                                    class="flex-1 bg-teal-500 hover:bg-teal-600 text-black font-bold py-3 rounded-lg transition-colors">
                                                    <%= article ? 'Update Article' : 'Publish Article' %>
                                                </button>
                                                <a href="/admin/articles"
                                                    class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-lg text-center transition-colors">Cancel</a>
                                            </div>
                                </form>

                    </div>
                </div>
        </main>

        <script>
            function updateToggleUI(source) {
                var fileContainer = document.getElementById('fileInputContainer');
                var urlContainer = document.getElementById('urlInputContainer');
                var highlight = document.getElementById('toggleHighlight');
                var labelFile = document.getElementById('labelFile');
                var labelUrl = document.getElementById('labelUrl');

                if (source === 'file') {
                    fileContainer.classList.remove('hidden');
                    urlContainer.classList.add('hidden');
                    if (highlight) {
                        highlight.style.left = '4px';
                        highlight.style.width = 'calc(50% - 4px)';
                    }
                    if (labelFile) { labelFile.className = 'text-sm font-semibold transition-colors duration-300 text-black'; }
                    if (labelUrl) { labelUrl.className = 'text-sm font-semibold transition-colors duration-300 text-gray-400'; }
                } else {
                    fileContainer.classList.add('hidden');
                    urlContainer.classList.remove('hidden');
                    if (highlight) {
                        highlight.style.left = '50%';
                        highlight.style.width = 'calc(50% - 4px)';
                    }
                    if (labelFile) { labelFile.className = 'text-sm font-semibold transition-colors duration-300 text-gray-400'; }
                    if (labelUrl) { labelUrl.className = 'text-sm font-semibold transition-colors duration-300 text-black'; }

                    var urlInp = urlContainer.querySelector('input');
                    if (urlInp && urlInp.value) handleUrlInput(urlInp);
                }
            }

            function clearPreview() {
                var preview = document.getElementById('imagePreview');
                var fileInp = document.getElementById('fileInput');
                var urlInp = document.querySelector('[name="imageUrl"]');
                preview.classList.add('hidden');
                if (fileInp) fileInp.value = '';
                if (urlInp) urlInp.value = '';
            }

            function handleFileSelect(input) {
                var file = input.files[0];
                var errorMsg = document.getElementById('fileError');
                var preview = document.getElementById('imagePreview');
                var previewImg = preview.querySelector('img');

                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        errorMsg.textContent = 'File size exceeds 5MB limit.';
                        errorMsg.classList.remove('hidden');
                        input.value = '';
                        preview.classList.add('hidden');
                        return;
                    }
                    var validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (validTypes.indexOf(file.type) === -1) {
                        errorMsg.textContent = 'Invalid file type. Only JPG, PNG, GIF, WEBP allowed.';
                        errorMsg.classList.remove('hidden');
                        input.value = '';
                        preview.classList.add('hidden');
                        return;
                    }
                    errorMsg.classList.add('hidden');
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        preview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            }

            function handleUrlInput(input) {
                var url = input.value;
                var preview = document.getElementById('imagePreview');
                var previewImg = preview.querySelector('img');
                if (url && /^https?:\/\/.+/.test(url)) {
                    previewImg.src = url;
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
            }

            // Initialize toggle on page load
            window.addEventListener('load', function () {
                var checked = document.querySelector('input[name="imageSource"]:checked');
                if (checked) {
                    updateToggleUI(checked.value);
                } else {
                    updateToggleUI('file');
                }
                if (window.lucide) window.lucide.createIcons();
            });

            // Ajax upload with progress
            (function () {
                var form = document.querySelector('form');
                var fileInput = document.querySelector('input[type="file"][name="image"]');
                var progress = document.getElementById('uploadProgress');
                var bar = document.getElementById('uploadBar');
                var ulLabel = document.getElementById('uploadLabel');
                var percentEl = document.getElementById('uploadPercent');
                var submitBtn = form.querySelector('button[type="submit"]');

                form.addEventListener('submit', function (e) {
                    var checkedRadio = document.querySelector('input[name="imageSource"]:checked');
                    var useFile = checkedRadio && checkedRadio.value === 'file';
                    var hasFile = fileInput && fileInput.files && fileInput.files.length > 0;

                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin inline mr-2"></i> Saving...';
                    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

                    if (!(useFile && hasFile)) {
                        return; // Normal submit
                    }

                    e.preventDefault();
                    progress.classList.remove('hidden');
                    ulLabel.textContent = 'Uploading...';
                    bar.style.width = '0%';
                    percentEl.textContent = '0%';

                    var formData = new FormData(form);
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', form.action, true);

                    xhr.upload.onprogress = function (evt) {
                        if (evt.lengthComputable) {
                            var pct = Math.round((evt.loaded / evt.total) * 100);
                            bar.style.width = pct + '%';
                            percentEl.textContent = pct + '%';
                        }
                    };

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status >= 200 && xhr.status < 400) {
                                ulLabel.textContent = 'Done!';
                                var finalUrl = xhr.responseURL || '/admin/articles';
                                window.location.href = finalUrl.indexOf('/admin/articles') !== -1 ? finalUrl : '/admin/articles?success=created';
                            } else {
                                progress.classList.add('hidden');
                                submitBtn.disabled = false;
                                submitBtn.textContent = '<%= article ? "Update Article" : "Publish Article" %>';
                                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                                try {
                                    document.open(); document.write(xhr.responseText); document.close();
                                } catch (err) {
                                    alert('Gagal menyimpan artikel. Coba lagi.');
                                }
                            }
                        }
                    };

                    xhr.send(formData);
                });
            })();
        </script>
        <script>lucide.createIcons();</script>
</body>

</html>