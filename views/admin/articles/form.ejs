<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= article ? 'Edit' : 'Write' %> Article - Admin Panel
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style type="text/tailwindcss">
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0a0a0a; color: white; }
        .sidebar-link { @apply flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all; }
        .sidebar-link.active { @apply bg-teal-500/10 text-teal-400; }
        input, textarea { @apply w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-teal-500 transition-colors text-white; }
        label { @apply block text-sm text-gray-400 mb-1; }
    </style>
</head>

<body class="flex min-h-screen">
    <%- include('../partials/sidebar', { path: '/admin/articles' }) %>

        <main class="flex-1 ml-64 p-8">
            <%- include('../partials/header', { title: article ? 'Edit Article' : 'Write New Article' }) %>

                <div class="max-w-4xl mx-auto">
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-8">
                        <div class="bg-white/5 border border-white/10 rounded-2xl p-8">
                            <% if (typeof error !=='undefined' && error) { %>
                                <div class="mb-4 p-4 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400">
                                    <%= error %>
                                </div>
                                <% } %>
                                    <form action="/admin/articles<%= article ? '/edit/' + article.id : '/create' %>"
                                        method="POST" enctype="multipart/form-data" class="space-y-6">
                                        <div>
                                            <label>Title</label>
                                            <input type="text" name="title" value="<%= article ? article.title : '' %>"
                                                required>
                                        </div>

                                        <div>
                                            <label>Content (HTML supported)</label>
                                            <textarea name="content" rows="12" required
                                                class="font-mono text-sm"><%= article ? article.content : '' %></textarea>
                                        </div>

                                        <div>
                                            <label>Tags (comma separated)</label>
                                            <input type="text" name="tags" value="<%= article ? article.tags : '' %>"
                                                placeholder="tech, tutorial, life">
                                        </div>

                                        <div class="space-y-4">
                                            <label class="text-sm font-medium text-gray-400">Cover Image</label>

                                            <% if (article && article.imageUrl) { %>
                                                <div class="group relative inline-block">
                                                    <% const _cur=article.imageUrl.startsWith('http') ?
                                                        ('https://images.weserv.nl/?url=' + encodeURIComponent(article.imageUrl)) : article.imageUrl; %>
                                                <img src="<%= _cur %>" alt="Current" class="h-40 w-auto rounded-xl object-cover border-2 border-white/10 group-hover:border-teal-500/50 transition-all shadow-2xl">
                                                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                                                    <span class="text-[10px] uppercase tracking-widest font-bold">Current Image</span>
                                                </div>
                                            </div>
                                        <% } %>

                                        <div class="bg-black/40 border border-white/5 rounded-2xl p-6 backdrop-blur-sm">
                                            <% const isUrl = article && article.imageUrl && !article.imageUrl.startsWith('
                                                        /uploads/'); %>

                                                        <!-- Modern Segmented Toggle -->
                                                        <div
                                                            class="inline-flex p-1 bg-white/5 rounded-xl mb-6 relative w-full sm:w-auto">
                                                            <div id="toggleHighlight"
                                                                class="absolute h-[calc(100%-8px)] transition-all duration-300 ease-out bg-teal-500 rounded-lg shadow-[0_0_20px_rgba(20,184,166,0.3)]">
                                                            </div>

                                                            <label
                                                                class="relative flex-1 sm:w-32 py-2 text-center cursor-pointer z-10">
                                                                <input type="radio" name="imageSource" value="file"
                                                                    <%=!isUrl ? 'checked' : '' %> class="sr-only"
                                                                onchange="updateToggleUI('file')">
                                                                <span
                                                                    class="text-sm font-semibold transition-colors duration-300 <%= !isUrl ? 'text-black' : 'text-gray-400' %>">Upload
                                                                    File</span>
                                                            </label>

                                                            <label
                                                                class="relative flex-1 sm:w-32 py-2 text-center cursor-pointer z-10">
                                                                <input type="radio" name="imageSource" value="url"
                                                                    <%=isUrl ? 'checked' : '' %> class="sr-only"
                                                                onchange="updateToggleUI('url')">
                                                                <span
                                                                    class="text-sm font-semibold transition-colors duration-300 <%= isUrl ? 'text-black' : 'text-gray-400' %>">Image
                                                                    URL</span>
                                                            </label>
                                                        </div>

                                                        <!-- Input Containers -->
                                                        <div class="space-y-4">
                                                            <div id="fileInputContainer"
                                                                class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                                                                <div
                                                                    class="border-2 border-dashed border-white/10 hover:border-teal-500/30 rounded-xl p-8 text-center transition-colors group">
                                                                    <input type="file" name="image" id="fileInput"
                                                                        accept="image/*"
                                                                        onchange="handleFileSelect(this)"
                                                                        class="sr-only">
                                                                    <label for="fileInput" class="cursor-pointer">
                                                                        <div
                                                                            class="bg-teal-500/10 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                                                            <i data-lucide="upload"
                                                                                class="w-6 h-6 text-teal-400"></i>
                                                                        </div>
                                                                        <p class="text-sm text-gray-300 font-medium">
                                                                            Click to upload or drag and drop</p>
                                                                        <p class="text-xs text-gray-500 mt-1">PNG, JPG,
                                                                            WEBP up to 5MB</p>
                                                                    </label>
                                                                </div>
                                                            </div>

                                                            <div id="urlInputContainer"
                                                                class="hidden animate-in fade-in slide-in-from-top-2 duration-300">
                                                                <div class="relative group">
                                                                    <div
                                                                        class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-500 group-focus-within:text-teal-400 transition-colors">
                                                                        <i data-lucide="link" class="w-4 h-4"></i>
                                                                    </div>
                                                                    <input type="url" name="imageUrl"
                                                                        value="<%= isUrl ? article.imageUrl : '' %>"
                                                                        placeholder="Paste image URL here..."
                                                                        oninput="handleUrlInput(this)"
                                                                        class="pl-11 pr-4 py-3 bg-black/40 border border-white/10 rounded-xl focus:ring-2 focus:ring-teal-500/20 w-full outline-none transition-all">
                                                                </div>
                                                            </div>

                                                            <!-- Unified Preview -->
                                                            <div id="imagePreview"
                                                                class="hidden group relative inline-block mt-4 overflow-hidden rounded-xl">
                                                                <p
                                                                    class="text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">
                                                                    Format Preview</p>
                                                                <img src="" alt="Preview"
                                                                    class="h-48 w-full object-cover rounded-xl border border-white/10 shadow-xl">
                                                                <button type="button" onclick="clearPreview()"
                                                                    class="absolute top-8 right-2 p-1.5 bg-red-500/80 hover:bg-red-500 text-white rounded-lg transition-all transform hover:scale-110">
                                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                                </button>
                                                            </div>

                                                            <p id="fileError"
                                                                class="text-xs text-red-400 font-medium hidden"></p>
                                                        </div>

                                                        <!-- Modern Progress -->
                                                        <div id="uploadProgress"
                                                            class="hidden mt-6 bg-white/5 rounded-2xl p-4 border border-white/5">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <div class="flex items-center gap-2">
                                                                    <div
                                                                        class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center">
                                                                        <i data-lucide="loader-2"
                                                                            class="w-4 h-4 text-teal-400 animate-spin"></i>
                                                                    </div>
                                                                    <span class="text-sm font-bold text-gray-200"
                                                                        id="uploadLabel">Processing...</span>
                                                                </div>
                                                                <span class="text-xs font-mono text-teal-400"
                                                                    id="uploadPercent">0%</span>
                                                            </div>
                                                            <div
                                                                class="w-full bg-white/5 rounded-full h-1.5 overflow-hidden">
                                                                <div id="uploadBar"
                                                                    class="bg-gradient-to-r from-teal-500 to-emerald-400 h-1.5 rounded-full transition-all duration-300"
                                                                    style="width:0%"></div>
                                                            </div>
                                                        </div>
                                                </div>
                                        </div>
                        </div>

                        <script>
                            function updateToggleUI(source) {
                                const fileContainer = document.getElementById('fileInputContainer');
                                const urlContainer = document.getElementById('urlInputContainer');
                                const highlight = document.getElementById('toggleHighlight');
                                const labels = document.querySelectorAll('[name="imageSource"] + span');

                                if (source === 'file') {
                                    fileContainer.classList.remove('hidden');
                                    urlContainer.classList.add('hidden');
                                    if (highlight) {
                                        highlight.style.left = '4px';
                                        highlight.style.width = 'calc(50% - 4px)';
                                    }
                                    if (labels.length >= 2) {
                                        labels[0].classList.add('text-black');
                                        labels[0].classList.remove('text-gray-400');
                                        labels[1].classList.add('text-gray-400');
                                        labels[1].classList.remove('text-black');
                                    }
                                } else {
                                    fileContainer.classList.add('hidden');
                                    urlContainer.classList.remove('hidden');
                                    if (highlight) {
                                        highlight.style.left = '50%';
                                        highlight.style.width = 'calc(50% - 4px)';
                                    }
                                    if (labels.length >= 2) {
                                        labels[1].classList.add('text-black');
                                        labels[1].classList.remove('text-gray-400');
                                        labels[0].classList.add('text-gray-400');
                                        labels[0].classList.remove('text-black');
                                    }

                                    const urlInp = urlContainer.querySelector('input');
                                    if (urlInp && urlInp.value) handleUrlInput(urlInp);
                                }
                            }

                            function clearPreview() {
                                const preview = document.getElementById('imagePreview');
                                const fileInp = document.getElementById('fileInput');
                                const urlInp = document.querySelector('[name="imageUrl"]');

                                preview.classList.add('hidden');
                                if (fileInp) fileInp.value = '';
                                if (urlInp) urlInp.value = '';
                            }

                            // Initialize on load
                            window.addEventListener('load', function () {
                                const checked = document.querySelector('input[name="imageSource"]:checked');
                                if (checked) updateToggleUI(checked.value);
                                else updateToggleUI('file');

                                if (window.lucide) window.lucide.createIcons();
                            });

                            function handleFileSelect(input) {
                                const file = input.files[0];
                                const errorMsg = document.getElementById('fileError');
                                const preview = document.getElementById('imagePreview');
                                const previewImg = preview.querySelector('img');

                                if (file) {
                                    if (file.size > 5 * 1024 * 1024) {
                                        errorMsg.textContent = 'File size exceeds 5MB limit.';
                                        errorMsg.classList.remove('hidden');
                                        input.value = '';
                                        preview.classList.add('hidden');
                                        return;
                                    }
                                    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                                    if (!validTypes.includes(file.type)) {
                                        errorMsg.textContent = 'Invalid file type. Only JPG, PNG, GIF, WEBP allowed.';
                                        errorMsg.classList.remove('hidden');
                                        input.value = '';
                                        preview.classList.add('hidden');
                                        return;
                                    }

                                    errorMsg.classList.add('hidden');

                                    const reader = new FileReader();
                                    reader.onload = function (e) {
                                        previewImg.src = e.target.result;
                                        preview.classList.remove('hidden');
                                    }
                                    reader.readAsDataURL(file);
                                }
                            }

                            function handleUrlInput(input) {
                                const url = input.value;
                                const preview = document.getElementById('imagePreview');
                                const previewImg = preview.querySelector('img');

                                if (url && url.match(/^https?:\/\/.+/)) {
                                    previewImg.src = url;
                                    preview.classList.remove('hidden');
                                    previewImg.onerror = function () {
                                        console.log('Image failed to load');
                                    }
                                } else {
                                    preview.classList.add('hidden');
                                }
                            }

                            // Improve Form Submission UX
                            (function attachAjaxSubmit() {
                                const form = document.querySelector('form');
                                const fileInput = document.querySelector('input[type="file"][name="image"]');
                                const progress = document.getElementById('uploadProgress');
                                const bar = document.getElementById('uploadBar');
                                const label = document.getElementById('uploadLabel');
                                const percentEl = document.getElementById('uploadPercent');
                                const submitBtn = form.querySelector('button[type="submit"]');

                                form.addEventListener('submit', function (e) {
                                    const useFile = document.querySelector('input[name="imageSource"]:checked')?.value === 'file';
                                    const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;

                                    submitBtn.disabled = true;
                                    submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin inline mr-2"></i> Saving...';
                                    submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

                                    if (!(useFile && hasFile)) {
                                        // No file upload, let browser submit normally
                                        return;
                                    }

                                    e.preventDefault();
                                    progress.classList.remove('hidden');
                                    label.textContent = 'Uploading...';
                                    bar.style.width = '0%';
                                    percentEl.textContent = '0%';

                                    const formData = new FormData(form);
                                    const xhr = new XMLHttpRequest();
                                    xhr.open('POST', form.action, true);

                                    xhr.upload.onprogress = function (evt) {
                                        if (evt.lengthComputable) {
                                            const pct = Math.round((evt.loaded / evt.total) * 100);
                                            bar.style.width = pct + '%';
                                            percentEl.textContent = pct + '%';
                                        }
                                    };

                                    xhr.onreadystatechange = function () {
                                        if (xhr.readyState === XMLHttpRequest.DONE) {
                                            // On success, server will redirect to /admin/articles
                                            if (xhr.status >= 200 && xhr.status < 400) {
                                                label.textContent = 'Processing...';
                                                // Follow redirect manually if any
                                                const finalUrl = xhr.responseURL || '/admin/articles';
                                                window.location.href = finalUrl.includes('/admin/articles') ? finalUrl : '/admin/articles?success=created';
                                            } else {
                                                // Rendered error HTML returned
                                                progress.classList.add('hidden');
                                                submitBtn.disabled = false;
                                                submitBtn.textContent = "<%= article ? 'Update Article' : 'Publish Article' %>";
                                                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                                                try {
                                                    // Basic fallback: reload to show server-rendered error
                                                    document.open(); document.write(xhr.responseText); document.close();
                                                } catch (_) {
                                                    alert('Gagal menyimpan artikel. Coba lagi.');
                                                }
                                            }
                                        }
                                    };

                                    xhr.send(formData);
                                });
                            })();
                        </script>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" name="published" id="published" class="w-5 h-5 accent-teal-500"
                                <%=article && article.published ? 'checked' : '' %>>
                            <label for="published" class="mb-0 cursor-pointer">Publish now?</label>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button type="submit"
                                class="flex-1 bg-teal-500 hover:bg-teal-600 text-black font-bold py-3 rounded-lg transition-colors">
                                <%= article ? 'Update Article' : 'Publish Article' %>
                            </button>
                            <a href="/admin/articles"
                                class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-lg text-center transition-colors">
                                Cancel
                            </a>
                        </div>
                        </form>
                    </div>
                </div>
        </main>
        <script>lucide.createIcons();</script>
</body>

</html>