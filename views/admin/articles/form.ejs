<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= article ? 'Edit' : 'Write' %> Article - Admin Panel
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style type="text/tailwindcss">
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0a0a0a; color: white; }
        .sidebar-link { @apply flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition-all; }
        .sidebar-link.active { @apply bg-teal-500/10 text-teal-400; }
        input, textarea { @apply w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 focus:outline-none focus:border-teal-500 transition-colors text-white; }
        label { @apply block text-sm text-gray-400 mb-1; }
    </style>
</head>

<body class="flex min-h-screen">
    <%- include('../partials/sidebar', { path: '/admin/articles' }) %>

        <main class="flex-1 ml-64 p-8">
            <%- include('../partials/header', { title: article ? 'Edit Article' : 'Write New Article' }) %>

                <div class="max-w-4xl mx-auto">
                    <div class="bg-white/5 border border-white/10 rounded-2xl p-8">
                        <div class="bg-red-500 text-white p-4 mb-4 rounded-xl font-bold text-center">
                            DEBUG: IF YOU SEE THIS, THE FILE IS UPDATED
                        </div>
                        <% if (typeof error !=='undefined' && error) { %>
                            <div class="mb-4 p-4 rounded-xl border border-red-500/30 bg-red-500/10 text-red-400">
                                <%= error %>
                            </div>
                            <% } %>
                                <form action="/admin/articles<%= article ? '/edit/' + article.id : '/create' %>"
                                    method="POST" enctype="multipart/form-data" class="space-y-6">
                                    <div>
                                        <label>Title</label>
                                        <input type="text" name="title" value="<%= article ? article.title : '' %>"
                                            required>
                                    </div>

                                    <div>
                                        <label>Content (HTML supported)</label>
                                        <textarea name="content" rows="12" required
                                            class="font-mono text-sm"><%= article ? article.content : '' %></textarea>
                                    </div>

                                    <div>
                                        <label>Tags (comma separated)</label>
                                        <input type="text" name="tags" value="<%= article ? article.tags : '' %>"
                                            placeholder="tech, tutorial, life">
                                    </div>

                                    <div>
                                        <label class="mb-2 block">Cover Image (Verified Fix)</label>

                                        <% if (article && article.imageUrl) { %>
                                            <div class="mb-4">
                                                <p class="text-xs text-gray-500 mb-1">Current Image:</p>
                                                <% const _cur=article.imageUrl.startsWith('http') ?
                                                    ('https://images.weserv.nl/?url=' + encodeURIComponent(article.imageUrl)) : article.imageUrl; %>
                                        <img src="<%= _cur %>" alt="Current Image"
                                            class="h-32 rounded object-cover border border-white/10">
                                    </div>
                                    <% } %>

                                    <div class="bg-black/20 border border-white/10 rounded-lg p-4">
                                        <% const isUrl = article && article.imageUrl && !article.imageUrl.startsWith('
                                                    /uploads/'); %>
                                                    <div
                                                        class="flex gap-2 text-xs mb-4 bg-black/40 rounded-lg p-1 w-full md:w-48">
                                                        <label
                                                            class="flex-1 text-center cursor-pointer py-1.5 px-2 rounded hover:bg-white/5 has-[:checked]:bg-teal-500/20 has-[:checked]:text-teal-400 transition-all font-medium text-gray-400">
                                                            <input type="radio" name="imageSource" value="file"
                                                                <%=!isUrl ? 'checked' : '' %> class="hidden"
                                                            onchange="toggleImageInput(this.value)">
                                                            Upload File
                                                        </label>
                                                        <label
                                                            class="flex-1 text-center cursor-pointer py-1.5 px-2 rounded hover:bg-white/5 has-[:checked]:bg-teal-500/20 has-[:checked]:text-teal-400 transition-all font-medium text-gray-400">
                                                            <input type="radio" name="imageSource" value="url" <%=isUrl
                                                                ? 'checked' : '' %> class="hidden"
                                                            onchange="toggleImageInput(this.value)">
                                                            Image URL
                                                        </label>
                                                    </div>

                                                    <!-- Preview Container -->
                                                    <div id="imagePreview" class="mb-4 hidden">
                                                        <p class="text-xs text-gray-500 mb-1">Preview:</p>
                                                        <img src="" alt="Preview"
                                                            class="h-48 rounded object-cover border border-white/10 w-full md:w-auto">
                                                    </div>

                                                    <div id="fileInputContainer" class="<%= isUrl ? 'hidden' : '' %>">
                                                        <input type="file" name="image"
                                                            accept="image/jpeg,image/png,image/gif,image/webp"
                                                            onchange="handleFileSelect(this)"
                                                            class="file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-500/10 file:text-teal-400 hover:file:bg-teal-500/20">
                                                        <p class="text-xs text-gray-500 mt-2">Max size: 5MB. Formats:
                                                            JPG, PNG, GIF, WEBP.</p>
                                                        <p id="fileError" class="text-xs text-red-500 mt-1 hidden"></p>
                                                    </div>

                                                    <div id="urlInputContainer" class="<%= !isUrl ? 'hidden' : '' %>">
                                                        <input type="url" name="imageUrl"
                                                            value="<%= isUrl ? article.imageUrl : '' %>"
                                                            placeholder="https://example.com/image.jpg"
                                                            oninput="handleUrlInput(this)"
                                                            class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:border-teal-500 transition-colors text-white">
                                                    </div>

                                                    <!-- Progress Indicator -->
                                                    <div id="uploadProgress" class="hidden mt-4">
                                                        <div class="flex items-center gap-2 text-sm text-teal-400 mb-1">
                                                            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                                            <span id="uploadLabel">Uploading...</span>
                                                            <span id="uploadPercent"
                                                                class="ml-auto text-xs text-gray-400">0%</span>
                                                        </div>
                                                        <div
                                                            class="w-full bg-white/10 rounded-full h-1.5 overflow-hidden">
                                                            <div id="uploadBar" class="bg-teal-500 h-1.5 rounded-full"
                                                                style="width:0%"></div>
                                                        </div>
                                                    </div>
                                            </div>
                                    </div>

                                    <script>
                                        function toggleImageInput(source) {
                                            const fileContainer = document.getElementById('fileInputContainer');
                                            const urlContainer = document.getElementById('urlInputContainer');
                                            const preview = document.getElementById('imagePreview');

                                            if (source === 'file') {
                                                fileContainer.classList.remove('hidden');
                                                urlContainer.classList.add('hidden');
                                            } else {
                                                fileContainer.classList.add('hidden');
                                                urlContainer.classList.remove('hidden');
                                                // Trigger preview check
                                                const urlVal = urlContainer.querySelector('input').value;
                                                if (urlVal) handleUrlInput(urlContainer.querySelector('input'));
                                            }
                                        }

                                        // Initialize on load
                                        window.addEventListener('load', function () {
                                            const checkedSource = document.querySelector('input[name="imageSource"]:checked')?.value;
                                            if (checkedSource) toggleImageInput(checkedSource);
                                        });

                                        function handleFileSelect(input) {
                                            const file = input.files[0];
                                            const errorMsg = document.getElementById('fileError');
                                            const preview = document.getElementById('imagePreview');
                                            const previewImg = preview.querySelector('img');

                                            if (file) {
                                                // Validation
                                                if (file.size > 5 * 1024 * 1024) {
                                                    errorMsg.textContent = 'File size exceeds 5MB limit.';
                                                    errorMsg.classList.remove('hidden');
                                                    input.value = ''; // Clear input
                                                    preview.classList.add('hidden');
                                                    return;
                                                }
                                                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                                                if (!validTypes.includes(file.type)) {
                                                    errorMsg.textContent = 'Invalid file type. Only JPG, PNG, GIF, WEBP allowed.';
                                                    errorMsg.classList.remove('hidden');
                                                    input.value = '';
                                                    preview.classList.add('hidden');
                                                    return;
                                                }

                                                errorMsg.classList.add('hidden');

                                                // Preview
                                                const reader = new FileReader();
                                                reader.onload = function (e) {
                                                    previewImg.src = e.target.result;
                                                    preview.classList.remove('hidden');
                                                }
                                                reader.readAsDataURL(file);
                                            }
                                        }

                                        function handleUrlInput(input) {
                                            const url = input.value;
                                            const preview = document.getElementById('imagePreview');
                                            const previewImg = preview.querySelector('img');

                                            if (url && url.match(/^https?:\/\/.+/)) {
                                                previewImg.src = url;
                                                preview.classList.remove('hidden');

                                                // Handle load error
                                                previewImg.onerror = function () {
                                                    // Maybe show a placeholder or keep hidden?
                                                    // For now, let's just not break
                                                    console.log('Image failed to load');
                                                }
                                            } else {
                                                preview.classList.add('hidden');
                                            }
                                        }

                                        // Improve Form Submission UX
                                        (function attachAjaxSubmit() {
                                            const form = document.querySelector('form');
                                            const fileInput = document.querySelector('input[type="file"][name="image"]');
                                            const progress = document.getElementById('uploadProgress');
                                            const bar = document.getElementById('uploadBar');
                                            const label = document.getElementById('uploadLabel');
                                            const percentEl = document.getElementById('uploadPercent');
                                            const submitBtn = form.querySelector('button[type="submit"]');

                                            form.addEventListener('submit', function (e) {
                                                const useFile = document.querySelector('input[name="imageSource"]:checked')?.value === 'file';
                                                const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;

                                                submitBtn.disabled = true;
                                                submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin inline mr-2"></i> Saving...';
                                                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

                                                if (!(useFile && hasFile)) {
                                                    // No file upload, let browser submit normally
                                                    return;
                                                }

                                                e.preventDefault();
                                                progress.classList.remove('hidden');
                                                label.textContent = 'Uploading...';
                                                bar.style.width = '0%';
                                                percentEl.textContent = '0%';

                                                const formData = new FormData(form);
                                                const xhr = new XMLHttpRequest();
                                                xhr.open('POST', form.action, true);

                                                xhr.upload.onprogress = function (evt) {
                                                    if (evt.lengthComputable) {
                                                        const pct = Math.round((evt.loaded / evt.total) * 100);
                                                        bar.style.width = pct + '%';
                                                        percentEl.textContent = pct + '%';
                                                    }
                                                };

                                                xhr.onreadystatechange = function () {
                                                    if (xhr.readyState === XMLHttpRequest.DONE) {
                                                        // On success, server will redirect to /admin/articles
                                                        if (xhr.status >= 200 && xhr.status < 400) {
                                                            label.textContent = 'Processing...';
                                                            // Follow redirect manually if any
                                                            const finalUrl = xhr.responseURL || '/admin/articles';
                                                            window.location.href = finalUrl.includes('/admin/articles') ? finalUrl : '/admin/articles?success=created';
                                                        } else {
                                                            // Rendered error HTML returned
                                                            progress.classList.add('hidden');
                                                            submitBtn.disabled = false;
                                                            submitBtn.textContent = "<%= article ? 'Update Article' : 'Publish Article' %>";
                                                            submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                                                            try {
                                                                // Basic fallback: reload to show server-rendered error
                                                                document.open(); document.write(xhr.responseText); document.close();
                                                            } catch (_) {
                                                                alert('Gagal menyimpan artikel. Coba lagi.');
                                                            }
                                                        }
                                                    }
                                                };

                                                xhr.send(formData);
                                            });
                                        })();
                                    </script>

                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" name="published" id="published"
                                            class="w-5 h-5 accent-teal-500" <%=article && article.published ? 'checked'
                                            : '' %>>
                                        <label for="published" class="mb-0 cursor-pointer">Publish now?</label>
                                    </div>

                                    <div class="flex gap-4 pt-4">
                                        <button type="submit"
                                            class="flex-1 bg-teal-500 hover:bg-teal-600 text-black font-bold py-3 rounded-lg transition-colors">
                                            <%= article ? 'Update Article' : 'Publish Article' %>
                                        </button>
                                        <a href="/admin/articles"
                                            class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-lg text-center transition-colors">
                                            Cancel
                                        </a>
                                    </div>
                                </form>
                    </div>
                </div>
        </main>
        <script>lucide.createIcons();</script>
</body>

</html>